<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  </head>
  <body>
    <!-- 启动界面 -->
    <div id="startScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; justify-content: center; align-items: center; z-index: 1000; font-family: Arial, sans-serif;">
      <div style="text-align: center; color: white;">
        <h1 style="font-size: 2.5em; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">🏯 千佛洞 AR</h1>
        <p style="font-size: 1.2em; margin-bottom: 30px; opacity: 0.9;">体验增强现实中的3D佛像</p>
        <button id="startButton" style="
          background: #fff; 
          color: #667eea; 
          border: none; 
          padding: 15px 30px; 
          font-size: 1.2em; 
          border-radius: 25px; 
          cursor: pointer; 
          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
          transition: transform 0.2s;
        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
          🎯 开始 AR 体验
        </button>
        <p style="font-size: 0.9em; margin-top: 20px; opacity: 0.7;">请确保您已允许摄像头权限</p>
      </div>
    </div>

    <a-scene mindar-image="imageTargetSrc: ./qianfo.mind" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false"
             loading-screen="enabled: false">
      
      <a-assets>
        <!-- 你的FBX模型 -->
        <a-asset-item id="buddhaModel" src="https://cdn.jsdelivr.net/gh/ARplus/AR-SLAM-3D@main/buddha.fbx"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
      
      <a-entity mindar-image-target="targetIndex: 0">
        <!-- 简单的FBX模型显示 -->
        <a-entity 
          id="mainModel"
          fbx-loader
          position="0 0 0" 
          rotation="0 0 0"
          scale="0.01 0.01 0.01"
          visible="true">
        </a-entity>
        
        <!-- 基础光照 -->
        <a-light type="ambient" color="#ffffff" intensity="0.6"></a-light>
        <a-light type="directional" position="1 1 1" color="#ffffff" intensity="0.8"></a-light>
      </a-entity>
      
    </a-scene>

    <script>
      // 专用FBX加载器组件 - 简化版
      AFRAME.registerComponent('fbx-loader', {
        init: function () {
          this.loadFBXModel();
        },
        
        loadFBXModel: function() {
          const el = this.el;
          console.log('🏯 开始加载Buddha FBX模型...');
          
          // 加载Three.js FBX Loader
          this.loadThreeJS().then(() => {
            this.loadFBX();
          }).catch(() => {
            console.log('❌ FBX加载器加载失败，显示占位符');
            this.showPlaceholder();
          });
        },
        
        loadThreeJS: function() {
          return new Promise((resolve, reject) => {
            if (window.THREE && window.THREE.FBXLoader) {
              resolve();
              return;
            }
            
            // 动态加载FBX加载器
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/loaders/FBXLoader.js';
            script.onload = () => {
              if (window.THREE && window.THREE.FBXLoader) {
                console.log('✅ FBX Loader已加载');
                resolve();
              } else {
                reject('FBX Loader初始化失败');
              }
            };
            script.onerror = reject;
            document.head.appendChild(script);
          });
        },
        
        loadFBX: function() {
          const el = this.el;
          const fbxUrl = 'https://cdn.jsdelivr.net/gh/ARplus/AR-SLAM-3D@main/buddha.fbx';
          
          console.log('📥 正在下载FBX文件:', fbxUrl);
          
          const loader = new THREE.FBXLoader();
          
          loader.load(
            fbxUrl,
            (fbx) => {
              console.log('🎉 Buddha FBX模型加载成功！');
              
              // 简单处理模型
              fbx.scale.setScalar(1); // 保持原始比例，通过a-entity的scale调整
              fbx.position.set(0, 0, 0);
              
              // 确保材质正常显示
              fbx.traverse((child) => {
                if (child.isMesh) {
                  if (child.material) {
                    if (Array.isArray(child.material)) {
                      child.material.forEach(mat => mat.needsUpdate = true);
                    } else {
                      child.material.needsUpdate = true;
                    }
                  }
                }
              });
              
              // 添加到场景
              el.setObject3D('mesh', fbx);
              
              // 检查并报告模型信息
              this.reportModelInfo(fbx);
              
              console.log('✅ Buddha模型已成功显示在AR场景中');
            },
            (progress) => {
              const percent = (progress.loaded / progress.total * 100);
              console.log('📊 下载进度:', percent.toFixed(1) + '%');
            },
            (error) => {
              console.error('❌ FBX加载失败:', error);
              this.showPlaceholder();
            }
          );
        },
        
        reportModelInfo: function(fbx) {
          console.log('📋 Buddha模型信息:');
          console.log('- 顶点数:', this.countVertices(fbx));
          console.log('- 材质数:', this.countMaterials(fbx));
          
          if (fbx.animations && fbx.animations.length > 0) {
            console.log('🎬 包含动画:', fbx.animations.length, '个');
            fbx.animations.forEach((anim, index) => {
              console.log(`  动画${index + 1}: ${anim.name || '未命名'} (${anim.duration.toFixed(2)}秒)`);
            });
          } else {
            console.log('📷 静态模型（无动画）');
          }
        },
        
        countVertices: function(object) {
          let count = 0;
          object.traverse((child) => {
            if (child.geometry) {
              const positions = child.geometry.attributes.position;
              if (positions) count += positions.count;
            }
          });
          return count;
        },
        
        countMaterials: function(object) {
          const materials = new Set();
          object.traverse((child) => {
            if (child.material) {
              if (Array.isArray(child.material)) {
                child.material.forEach(mat => materials.add(mat));
              } else {
                materials.add(child.material);
              }
            }
          });
          return materials.size;
        },
        
        showPlaceholder: function() {
          console.log('📦 显示简单占位符...');
          const geometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
          const material = new THREE.MeshBasicMaterial({color: 0xffaa00});
          const cube = new THREE.Mesh(geometry, material);
          this.el.setObject3D('mesh', cube);
        }
      });

      document.addEventListener('DOMContentLoaded', function() {
        const startScreen = document.getElementById('startScreen');
        const startButton = document.getElementById('startButton');
        const scene = document.querySelector('a-scene');
        
        // 初始隐藏场景
        scene.style.display = 'none';
        
        // 启动按钮点击事件
        startButton.addEventListener('click', async function() {
          try {
            startScreen.style.display = 'none';
            scene.style.display = 'block';
            
            await new Promise(resolve => {
              if (scene.hasLoaded) {
                resolve();
              } else {
                scene.addEventListener('loaded', resolve);
              }
            });
            
            console.log('🎯 AR场景已启动，等待FBX模型加载...');
            
          } catch (error) {
            console.error('启动AR失败:', error);
            alert('启动AR失败，请检查摄像头权限并刷新页面重试');
            startScreen.style.display = 'flex';
            scene.style.display = 'none';
          }
        });
        
        // 监听识别状态
        document.addEventListener('DOMContentLoaded', function() {
          const targetEntity = document.querySelector('[mindar-image-target]');
          
          if (targetEntity) {
            targetEntity.addEventListener('targetFound', function() {
              console.log('🎯 识别目标找到 - Buddha模型应该可见');
            });
            
            targetEntity.addEventListener('targetLost', function() {
              console.log('👻 识别目标丢失 - Buddha模型隐藏');
            });
          }
        });
      });
    </script>
  </body>
</html>
