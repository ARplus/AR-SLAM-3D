<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>千佛洞时光之门 AR 复原 Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

  <!-- A-Frame 核心 -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <!-- MindAR for A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-aframe.prod.js"></script>
  <!-- 粒子特效组件 -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-particle-system-component@1.0.0/dist/aframe-particle-system-component.min.js"></script>
  <!-- 手势识别 -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-gesture-detector@4.0.2/dist/aframe-gesture-detector.min.js"></script>

  <style>
    /* 启动页 & 加载提示 样式 */
    #startScreen {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; font-family: Arial, sans-serif; color: white;
    }
    #startScreen h1 {
      font-size: 3em; margin-bottom: 20px;
      text-shadow: 0 0 20px rgba(255,215,0,0.5);
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    #startScreen p { opacity: 0.9; margin: 0 0 10px; }
    #startButton {
      background: linear-gradient(45deg, #ffd700, #ff6b6b);
      color: white; border: none; padding: 18px 40px;
      font-size: 1.3em; font-weight: bold; border-radius: 30px;
      cursor: pointer; box-shadow: 0 5px 20px rgba(255,215,0,0.4);
      transition: all 0.3s; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    #startButton:hover {
      transform: scale(1.05) translateY(-2px);
      box-shadow: 0 7px 25px rgba(255,215,0,0.6);
    }
    .loading-text {
      position: fixed; top:50%; left:50%;
      transform: translate(-50%,-50%);
      color: white; font-size: 24px; z-index: 999;
      display: none;
    }
    /* 隐藏场景直到加载/启动 */
    a-scene { display: none; }
  </style>

  <script>
    // 手势旋转 + 缩放组件
    AFRAME.registerComponent('gesture-handler', {
      init: function () {
        this.onRotate = this.onRotate.bind(this);
        this.onPinch  = this.onPinch.bind(this);
        this.el.addEventListener('rotate', this.onRotate);
        this.el.addEventListener('pinch',  this.onPinch);
      },
      onRotate: function (ev) {
        const rot = this.el.getAttribute('rotation');
        this.el.setAttribute('rotation', {
          x: rot.x,
          y: rot.y + ev.detail.positionChange.x,
          z: rot.z
        });
      },
      onPinch: function (ev) {
        const scale = this.el.getAttribute('scale');
        const newS = scale.x * ev.detail.spreadChange;
        this.el.setAttribute('scale', `${newS} ${newS} ${newS}`);
      }
    });
  </script>
</head>

<body>
  <!-- 启动界面 -->
  <div id="startScreen">
    <div style="text-align:center;">
      <h1>✨ 千佛洞时光之门 ✨</h1>
      <p>穿越千年，见证石窟重生</p>
      <p style="opacity:0.7;">体验神秘的AR复原之旅</p>
      <button id="startButton">🎯 开启时光之门</button>
      <p style="margin-top:20px;opacity:0.6;">请确保已允许摄像头权限</p>
    </div>
  </div>
  <div class="loading-text">正在加载场景...</div>

  <!-- AR 场景 -->
  <a-scene
    mindar-image="imageTargetSrc: ./qianfo.mind; maxTrack: 1;"
    embedded
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    renderer="colorManagement: true, physicallyCorrectLights: true"
    loading-screen="enabled: false"
  >
    <a-assets>
      <!-- GLB 模型 -->
      <a-asset-item id="buddhistModel" src="./buddhist.glb"></a-asset-item>
      <a-asset-item id="cloudModel"    src="./cloud.glb"></a-asset-item>
      <a-asset-item id="dragonModel"   src="./dragon.glb"></a-asset-item>
      <!-- 音效 -->
      <audio id="bell"  src="./bell.mp3"  preload="auto"></audio>
      <audio id="chant" src="./chant.mp3" preload="auto"></audio>
    </a-assets>

    <!-- 摄像头 -->
    <a-camera position="0 0 0"></a-camera>

    <!-- 识别到目标后内容 -->
    <a-entity mindar-image-target="targetIndex: 0">
      <!-- 改进版粒子系统 -->
      <a-entity particle-system="
        preset: dust;
        particleCount: 800;
        color: #dddddd,#888888;
        size: 0.02;
        opacity: 0.6;
        velocityValue: 0 0.5 0;
        accelerationValue: 0 -0.1 0;
        duration: 6;
        blending: additive;
        texture: https://cdn.jsdelivr.net/gh/aframevr/aframe-particle-system-component@master/dist/images/spark1.png
      "></a-entity>

      <!-- 模型组：支持整体手势旋转/缩放 -->
      <a-entity id="modelGroup"
                gesture-handler
                position="0 0 0"
                rotation="0 0 0"
                scale="0.1 0.1 0.1"
      >
        <a-gltf-model src="#buddhistModel"></a-gltf-model>
        <a-gltf-model src="#cloudModel"    position="0 0 0"></a-gltf-model>
        <a-gltf-model src="#dragonModel"   position="0 0 0"></a-gltf-model>
      </a-entity>

      <!-- 音源实体（不自动播放） -->
      <a-entity id="soundBell"  sound="src: #bell;  autoplay: false;"></a-entity>
      <a-entity id="soundChant" sound="src: #chant; autoplay: false;"></a-entity>
    </a-entity>
  </a-scene>

  <!-- 启动 & 音频逻辑 -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const startScreen = document.getElementById('startScreen');
      const startButton = document.getElementById('startButton');
      const loadingText = document.querySelector('.loading-text');
      const sceneEl = document.querySelector('a-scene');

      // 点击启动
      startButton.addEventListener('click', async () => {
        startScreen.style.display = 'none';
        loadingText.style.display = 'block';
        sceneEl.style.display = 'block';
        try {
          await new Promise(resolve => {
            if (sceneEl.hasLoaded) resolve();
            else sceneEl.addEventListener('loaded', resolve);
          });
          loadingText.style.display = 'none';
          initAR();
        } catch (e) {
          alert('AR 启动失败，请检查摄像头权限后重试');
          startScreen.style.display = 'flex';
          sceneEl.style.display = 'none';
          loadingText.style.display = 'none';
        }
      });

      function initAR() {
        const target = document.querySelector('[mindar-image-target]');
        const audioCtx = AFRAME.audioListener.context;
        const bellComp  = document.querySelector('#soundBell').components.sound;
        const chantComp = document.querySelector('#soundChant').components.sound;

        // 防止 AudioContext 被挂起
        ['click','touchend'].forEach(evt => {
          window.addEventListener(evt, () => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
          });
        });

        target.addEventListener('targetFound', () => {
          if (audioCtx.state === 'suspended') audioCtx.resume();
          bellComp.playSound();
          // 梵音稍后播放
          setTimeout(() => chantComp.playSound(), 1500);
        });

        target.addEventListener('targetLost', () => {
          bellComp.stopSound();
          chantComp.stopSound();
        });
      }
    });
  </script>
</body>
</html>
