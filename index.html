<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>åƒä½›æ´æ—¶å…‰ä¹‹é—¨ AR å¤åŸ Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

  <!-- A-Frame æ ¸å¿ƒ -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <!-- MindAR for A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-aframe.prod.js"></script>
  <!-- ç²’å­ç‰¹æ•ˆç»„ä»¶ -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-particle-system-component@1.0.0/dist/aframe-particle-system-component.min.js"></script>
  <!-- æ‰‹åŠ¿è¯†åˆ« -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-gesture-detector@4.0.2/dist/aframe-gesture-detector.min.js"></script>

  <style>
    /* å¯åŠ¨é¡µ & åŠ è½½æç¤º æ ·å¼ */
    #startScreen {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; font-family: Arial, sans-serif; color: white;
    }
    #startScreen h1 {
      font-size: 3em; margin-bottom: 20px;
      text-shadow: 0 0 20px rgba(255,215,0,0.5);
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    #startScreen p { opacity: 0.9; margin: 0 0 10px; }
    #startButton {
      background: linear-gradient(45deg, #ffd700, #ff6b6b);
      color: white; border: none; padding: 18px 40px;
      font-size: 1.3em; font-weight: bold; border-radius: 30px;
      cursor: pointer; box-shadow: 0 5px 20px rgba(255,215,0,0.4);
      transition: all 0.3s; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    #startButton:hover {
      transform: scale(1.05) translateY(-2px);
      box-shadow: 0 7px 25px rgba(255,215,0,0.6);
    }
    .loading-text {
      position: fixed; top:50%; left:50%;
      transform: translate(-50%,-50%);
      color: white; font-size: 24px; z-index: 999;
      display: none;
    }
    /* éšè—åœºæ™¯ç›´åˆ°åŠ è½½/å¯åŠ¨ */
    a-scene { display: none; }
  </style>

  <script>
    // æ‰‹åŠ¿æ—‹è½¬ + ç¼©æ”¾ç»„ä»¶
    AFRAME.registerComponent('gesture-handler', {
      init: function () {
        this.onRotate = this.onRotate.bind(this);
        this.onPinch  = this.onPinch.bind(this);
        this.el.addEventListener('rotate', this.onRotate);
        this.el.addEventListener('pinch',  this.onPinch);
      },
      onRotate: function (ev) {
        const rot = this.el.getAttribute('rotation');
        this.el.setAttribute('rotation', {
          x: rot.x,
          y: rot.y + ev.detail.positionChange.x,
          z: rot.z
        });
      },
      onPinch: function (ev) {
        const scale = this.el.getAttribute('scale');
        const newS = scale.x * ev.detail.spreadChange;
        this.el.setAttribute('scale', `${newS} ${newS} ${newS}`);
      }
    });
  </script>
</head>

<body>
  <!-- å¯åŠ¨ç•Œé¢ -->
  <div id="startScreen">
    <div style="text-align:center;">
      <h1>âœ¨ åƒä½›æ´æ—¶å…‰ä¹‹é—¨ âœ¨</h1>
      <p>ç©¿è¶Šåƒå¹´ï¼Œè§è¯çŸ³çªŸé‡ç”Ÿ</p>
      <p style="opacity:0.7;">ä½“éªŒç¥ç§˜çš„ARå¤åŸä¹‹æ—…</p>
      <button id="startButton">ğŸ¯ å¼€å¯æ—¶å…‰ä¹‹é—¨</button>
      <p style="margin-top:20px;opacity:0.6;">è¯·ç¡®ä¿å·²å…è®¸æ‘„åƒå¤´æƒé™</p>
    </div>
  </div>
  <div class="loading-text">æ­£åœ¨åŠ è½½åœºæ™¯...</div>

  <!-- AR åœºæ™¯ -->
  <a-scene
    mindar-image="imageTargetSrc: ./qianfo.mind; maxTrack: 1;"
    embedded
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    renderer="colorManagement: true, physicallyCorrectLights: true"
    loading-screen="enabled: false"
  >
    <a-assets>
      <!-- GLB æ¨¡å‹ -->
      <a-asset-item id="buddhistModel" src="./buddhist.glb"></a-asset-item>
      <a-asset-item id="cloudModel"    src="./cloud.glb"></a-asset-item>
      <a-asset-item id="dragonModel"   src="./dragon.glb"></a-asset-item>
      <!-- éŸ³æ•ˆ -->
      <audio id="bell"  src="./bell.mp3"  preload="auto"></audio>
      <audio id="chant" src="./chant.mp3" preload="auto"></audio>
    </a-assets>

    <!-- æ‘„åƒå¤´ -->
    <a-camera position="0 0 0"></a-camera>

    <!-- è¯†åˆ«åˆ°ç›®æ ‡åå†…å®¹ -->
    <a-entity mindar-image-target="targetIndex: 0">
      <!-- æ”¹è¿›ç‰ˆç²’å­ç³»ç»Ÿ -->
      <a-entity particle-system="
        preset: dust;
        particleCount: 800;
        color: #dddddd,#888888;
        size: 0.02;
        opacity: 0.6;
        velocityValue: 0 0.5 0;
        accelerationValue: 0 -0.1 0;
        duration: 6;
        blending: additive;
        texture: https://cdn.jsdelivr.net/gh/aframevr/aframe-particle-system-component@master/dist/images/spark1.png
      "></a-entity>

      <!-- æ¨¡å‹ç»„ï¼šæ”¯æŒæ•´ä½“æ‰‹åŠ¿æ—‹è½¬/ç¼©æ”¾ -->
      <a-entity id="modelGroup"
                gesture-handler
                position="0 0 0"
                rotation="0 0 0"
                scale="0.1 0.1 0.1"
      >
        <a-gltf-model src="#buddhistModel"></a-gltf-model>
        <a-gltf-model src="#cloudModel"    position="0 0 0"></a-gltf-model>
        <a-gltf-model src="#dragonModel"   position="0 0 0"></a-gltf-model>
      </a-entity>

      <!-- éŸ³æºå®ä½“ï¼ˆä¸è‡ªåŠ¨æ’­æ”¾ï¼‰ -->
      <a-entity id="soundBell"  sound="src: #bell;  autoplay: false;"></a-entity>
      <a-entity id="soundChant" sound="src: #chant; autoplay: false;"></a-entity>
    </a-entity>
  </a-scene>

  <!-- å¯åŠ¨ & éŸ³é¢‘é€»è¾‘ -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const startScreen = document.getElementById('startScreen');
      const startButton = document.getElementById('startButton');
      const loadingText = document.querySelector('.loading-text');
      const sceneEl = document.querySelector('a-scene');

      // ç‚¹å‡»å¯åŠ¨
      startButton.addEventListener('click', async () => {
        startScreen.style.display = 'none';
        loadingText.style.display = 'block';
        sceneEl.style.display = 'block';
        try {
          await new Promise(resolve => {
            if (sceneEl.hasLoaded) resolve();
            else sceneEl.addEventListener('loaded', resolve);
          });
          loadingText.style.display = 'none';
          initAR();
        } catch (e) {
          alert('AR å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‘„åƒå¤´æƒé™åé‡è¯•');
          startScreen.style.display = 'flex';
          sceneEl.style.display = 'none';
          loadingText.style.display = 'none';
        }
      });

      function initAR() {
        const target = document.querySelector('[mindar-image-target]');
        const audioCtx = AFRAME.audioListener.context;
        const bellComp  = document.querySelector('#soundBell').components.sound;
        const chantComp = document.querySelector('#soundChant').components.sound;

        // é˜²æ­¢ AudioContext è¢«æŒ‚èµ·
        ['click','touchend'].forEach(evt => {
          window.addEventListener(evt, () => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
          });
        });

        target.addEventListener('targetFound', () => {
          if (audioCtx.state === 'suspended') audioCtx.resume();
          bellComp.playSound();
          // æ¢µéŸ³ç¨åæ’­æ”¾
          setTimeout(() => chantComp.playSound(), 1500);
        });

        target.addEventListener('targetLost', () => {
          bellComp.stopSound();
          chantComp.stopSound();
        });
      }
    });
  </script>
</body>
</html>
