<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  </head>
  <body>
    <!-- å¯åŠ¨ç•Œé¢ -->
    <div id="startScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; justify-content: center; align-items: center; z-index: 1000; font-family: Arial, sans-serif;">
      <div style="text-align: center; color: white;">
        <h1 style="font-size: 2.5em; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">ğŸ¯ åƒä½›æ´ AR</h1>
        <p style="font-size: 1.2em; margin-bottom: 30px; opacity: 0.9;">ä½“éªŒå¢å¼ºç°å®ä¸­çš„3Dä½›åƒ</p>
        <button id="startButton" style="
          background: #fff; 
          color: #667eea; 
          border: none; 
          padding: 15px 30px; 
          font-size: 1.2em; 
          border-radius: 25px; 
          cursor: pointer; 
          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
          transition: transform 0.2s;
        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
          ğŸ¯ å¼€å§‹ AR ä½“éªŒ
        </button>
        <p style="font-size: 0.9em; margin-top: 20px; opacity: 0.7;">è¯·ç¡®ä¿æ‚¨å·²å…è®¸æ‘„åƒå¤´æƒé™</p>
      </div>
    </div>

    <a-scene mindar-image="imageTargetSrc: ./qianfo.mind" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false"
             loading-screen="enabled: false">
      
      <a-assets>
        <!-- ä½ çš„FBXæ¨¡å‹ -->
        <a-asset-item id="buddhaModel" src="https://cdn.jsdelivr.net/gh/ARplus/AR-SLAM-3D@main/buddha.fbx"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
      
      <a-entity mindar-image-target="targetIndex: 0">
        <!-- ç®€å•çš„FBXæ¨¡å‹æ˜¾ç¤º -->
        <a-entity 
          id="mainModel"
          fbx-loader
          position="0 0 0" 
          rotation="0 0 0"
          scale="0.01 0.01 0.01"
          visible="true">
        </a-entity>
        
        <!-- åŸºç¡€å…‰ç…§ -->
        <a-light type="ambient" color="#ffffff" intensity="0.6"></a-light>
        <a-light type="directional" position="1 1 1" color="#ffffff" intensity="0.8"></a-light>
      </a-entity>
      
    </a-scene>

    <script>
      // ä¸“ç”¨FBXåŠ è½½å™¨ç»„ä»¶ - ç®€åŒ–ç‰ˆ
      AFRAME.registerComponent('fbx-loader', {
        init: function () {
          this.loadFBXModel();
        },
        
        loadFBXModel: function() {
          const el = this.el;
          console.log('ğŸ¯ å¼€å§‹åŠ è½½Buddha FBXæ¨¡å‹...');
          
          // åŠ è½½Three.js FBX Loader
          this.loadThreeJS().then(() => {
            this.loadFBX();
          }).catch(() => {
            console.log('âŒ FBXåŠ è½½å™¨åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºå ä½ç¬¦');
            this.showPlaceholder();
          });
        },
        
        loadThreeJS: function() {
          return new Promise((resolve, reject) => {
            if (window.THREE && window.THREE.FBXLoader) {
              resolve();
              return;
            }
            
            // åŠ¨æ€åŠ è½½FBXåŠ è½½å™¨
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/loaders/FBXLoader.js';
            script.onload = () => {
              if (window.THREE && window.THREE.FBXLoader) {
                console.log('âœ… FBX Loaderå·²åŠ è½½');
                resolve();
              } else {
                reject('FBX Loaderåˆå§‹åŒ–å¤±è´¥');
              }
            };
            script.onerror = reject;
            document.head.appendChild(script);
          });
        },
        
        loadFBX: function() {
          const el = this.el;
          const fbxUrl = 'https://cdn.jsdelivr.net/gh/ARplus/AR-SLAM-3D@main/buddha.fbx';
          
          console.log('ğŸ“¥ æ­£åœ¨ä¸‹è½½FBXæ–‡ä»¶:', fbxUrl);
          
          const loader = new THREE.FBXLoader();
          
          loader.load(
            fbxUrl,
            (fbx) => {
              console.log('ğŸ‰ Buddha FBXæ¨¡å‹åŠ è½½æˆåŠŸï¼');
              
              // ç®€å•å¤„ç†æ¨¡å‹
              fbx.scale.setScalar(1); // ä¿æŒåŸå§‹æ¯”ä¾‹ï¼Œé€šè¿‡a-entityçš„scaleè°ƒæ•´
              fbx.position.set(0, 0, 0);
              
              // ç¡®ä¿æè´¨æ­£å¸¸æ˜¾ç¤º
              fbx.traverse((child) => {
                if (child.isMesh) {
                  if (child.material) {
                    if (Array.isArray(child.material)) {
                      child.material.forEach(mat => mat.needsUpdate = true);
                    } else {
                      child.material.needsUpdate = true;
                    }
                  }
                }
              });
              
              // æ·»åŠ åˆ°åœºæ™¯
              el.setObject3D('mesh', fbx);
              
              // æ£€æŸ¥å¹¶æŠ¥å‘Šæ¨¡å‹ä¿¡æ¯
              this.reportModelInfo(fbx);
              
              console.log('âœ… Buddhaæ¨¡å‹å·²æˆåŠŸæ˜¾ç¤ºåœ¨ARåœºæ™¯ä¸­');
            },
            (progress) => {
              const percent = (progress.loaded / progress.total * 100);
              console.log('ğŸ“Š ä¸‹è½½è¿›åº¦:', percent.toFixed(1) + '%');
            },
            (error) => {
              console.error('âŒ FBXåŠ è½½å¤±è´¥:', error);
              this.showPlaceholder();
            }
          );
        },
        
        reportModelInfo: function(fbx) {
          console.log('ğŸ“‹ Buddhaæ¨¡å‹ä¿¡æ¯:');
          console.log('- é¡¶ç‚¹æ•°:', this.countVertices(fbx));
          console.log('- æè´¨æ•°:', this.countMaterials(fbx));
          
          if (fbx.animations && fbx.animations.length > 0) {
            console.log('ğŸ¬ åŒ…å«åŠ¨ç”»:', fbx.animations.length, 'ä¸ª');
            fbx.animations.forEach((anim, index) => {
              console.log(`  åŠ¨ç”»${index + 1}: ${anim.name || 'æœªå‘½å'} (${anim.duration.toFixed(2)}ç§’)`);
            });
          } else {
            console.log('ğŸ“· é™æ€æ¨¡å‹ï¼ˆæ— åŠ¨ç”»ï¼‰');
          }
        },
        
        countVertices: function(object) {
          let count = 0;
          object.traverse((child) => {
            if (child.geometry) {
              const positions = child.geometry.attributes.position;
              if (positions) count += positions.count;
            }
          });
          return count;
        },
        
        countMaterials: function(object) {
          const materials = new Set();
          object.traverse((child) => {
            if (child.material) {
              if (Array.isArray(child.material)) {
                child.material.forEach(mat => materials.add(mat));
              } else {
                materials.add(child.material);
              }
            }
          });
          return materials.size;
        },
        
        showPlaceholder: function() {
          console.log('ğŸ“¦ æ˜¾ç¤ºç®€å•å ä½ç¬¦...');
          const geometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
          const material = new THREE.MeshBasicMaterial({color: 0xffaa00});
          const cube = new THREE.Mesh(geometry, material);
          this.el.setObject3D('mesh', cube);
        }
      });

      document.addEventListener('DOMContentLoaded', function() {
        const startScreen = document.getElementById('startScreen');
        const startButton = document.getElementById('startButton');
        const scene = document.querySelector('a-scene');
        
        // åˆå§‹éšè—åœºæ™¯
        scene.style.display = 'none';
        
        // å¯åŠ¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        startButton.addEventListener('click', async function() {
          try {
            startScreen.style.display = 'none';
            scene.style.display = 'block';
            
            await new Promise(resolve => {
              if (scene.hasLoaded) {
                resolve();
              } else {
                scene.addEventListener('loaded', resolve);
              }
            });
            
            console.log('ğŸ¯ ARåœºæ™¯å·²å¯åŠ¨ï¼Œç­‰å¾…FBXæ¨¡å‹åŠ è½½...');
            
          } catch (error) {
            console.error('å¯åŠ¨ARå¤±è´¥:', error);
            alert('å¯åŠ¨ARå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‘„åƒå¤´æƒé™å¹¶åˆ·æ–°é¡µé¢é‡è¯•');
            startScreen.style.display = 'flex';
            scene.style.display = 'none';
          }
        });
        
        // ç›‘å¬è¯†åˆ«çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
          const targetEntity = document.querySelector('[mindar-image-target]');
          
          if (targetEntity) {
            targetEntity.addEventListener('targetFound', function() {
              console.log('ğŸ¯ è¯†åˆ«ç›®æ ‡æ‰¾åˆ° - Buddhaæ¨¡å‹åº”è¯¥å¯è§');
            });
            
            targetEntity.addEventListener('targetLost', function() {
              console.log('ğŸ‘» è¯†åˆ«ç›®æ ‡ä¸¢å¤± - Buddhaæ¨¡å‹éšè—');
            });
          }
        });
      });
    </script>
  </body>
</html>
