<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <!-- A-Frameç²’å­ç³»ç»Ÿ -->
    <script src="https://cdn.jsdelivr.net/gh/IdeaSpaceVR/aframe-particle-system-component@master/dist/aframe-particle-system-component.min.js"></script>
  </head>
  <body>
    <!-- å¯åŠ¨ç•Œé¢ -->
    <div id="startScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; justify-content: center; align-items: center; z-index: 1000; font-family: Arial, sans-serif;">
      <div style="text-align: center; color: white;">
        <h1 style="font-size: 2.5em; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">ğŸ§˜ ä½›åƒ AR</h1>
        <p style="font-size: 1.2em; margin-bottom: 30px; opacity: 0.9;">ä½“éªŒç¥åœ£æ˜¾ç°çš„å¢å¼ºç°å®ä½›åƒ</p>
        <p style="font-size: 1em; margin-bottom: 20px; opacity: 0.8;">âœ¨ æ‰«æè¯†åˆ«å›¾ä½“éªŒç¥åœ£çš„ä½›å…‰æ˜¾ç°ç‰¹æ•ˆ</p>
        <button id="startButton" style="
          background: #fff; 
          color: #667eea; 
          border: none; 
          padding: 15px 30px; 
          font-size: 1.2em; 
          border-radius: 25px; 
          cursor: pointer; 
          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
          transition: transform 0.2s;
        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
          ğŸ¯ å¼€å§‹ç¥åœ£ä½“éªŒ
        </button>
        <p style="font-size: 0.9em; margin-top: 20px; opacity: 0.7;">è¯·ç¡®ä¿æ‚¨å·²å…è®¸æ‘„åƒå¤´æƒé™</p>
      </div>
    </div>

    <!-- æç¤ºæ–‡å­— -->
    <div id="instruction" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); color: white; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 20px; font-family: Arial, sans-serif; display: none; z-index: 9999; font-size: 14px;">
      ğŸ‘† ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯ä»¥æ”¾å¤§ä½›åƒ
    </div>

    <!-- æ”¾å¤§æŒ‰é’® -->
    <div id="zoomButton" style="position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: linear-gradient(45deg, #ffd700, #ff8f00); color: white; border: none; padding: 18px 30px; border-radius: 30px; font-family: Arial, sans-serif; font-weight: bold; display: block; z-index: 9999; font-size: 18px; box-shadow: 0 6px 20px rgba(255,215,0,0.4); cursor: pointer; user-select: none; min-width: 140px; text-align: center;">
      ğŸ” æ”¾å¤§ä½›åƒ
    </div>

    <!-- ç‰¹æ•ˆæ§åˆ¶æŒ‰é’® -->
    <div id="effectButton" style="position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white; border: none; padding: 15px 25px; border-radius: 25px; font-family: Arial, sans-serif; font-weight: bold; display: block; z-index: 9999; font-size: 16px; box-shadow: 0 4px 15px rgba(255,107,107,0.4); cursor: pointer; user-select: none; min-width: 120px; text-align: center;">
      âœ¨ é‡æ’­ç‰¹æ•ˆ
    </div>

    <!-- è°ƒè¯•ä¿¡æ¯ -->
    <div id="debugInfo" style="position: fixed; top: 80px; left: 20px; color: white; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 10px; font-family: monospace, sans-serif; display: block; z-index: 9999; font-size: 12px;">
      çŠ¶æ€: ç­‰å¾…å¯åŠ¨
    </div>

    <a-scene mindar-image="imageTargetSrc: ./qianfo.mind" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false"
             loading-screen="enabled: false">
      
      <a-assets>
        <!-- ä½›åƒ3Dæ¨¡å‹ -->
        <a-asset-item id="buddhistModel" src="./buddhist.glb"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
      
      <a-entity mindar-image-target="targetIndex: 0" id="mainTarget">
        
        <!-- æ˜¾ç°ç‰¹æ•ˆç²’å­ç³»ç»Ÿ -->
        <a-entity id="manifestationParticles" 
                  position="0 0 0.1"
                  particle-system="preset: dust; particleCount: 150; maxAge: 3; texture: ./dust-particle.svg; color: #FFD700,#FFA500; size: 0.5,0.05; velocity: 0 2 0; accelerationValue: 0 -1 0"
                  visible="false">
        </a-entity>

        <!-- ä½›å…‰ç²’å­ç³»ç»Ÿ -->
        <a-entity id="divineLight" 
                  position="0 2 0"
                  particle-system="preset: default; particleCount: 200; maxAge: 4; texture: ./light-particle.svg; color: #FFFFFF,#FFD700,#FFF8DC; size: 0.8,0.1; velocity: 0 -3 0; accelerationValue: 0 0.5 0; opacity: 0.8,0.2"
                  visible="false">
        </a-entity>

        <!-- ç¯ç»•å…‰ç²’å­ -->
        <a-entity id="ambientParticles" 
                  position="0 0 0.2"
                  particle-system="preset: default; particleCount: 80; maxAge: 8; color: #FFD700,#FFECB3; size: 0.3,0.05; velocity: 0 0.5 0; accelerationValue: 0 0 0; opacity: 0.6,0.1"
                  visible="false"
                  animation="property: rotation; to: 0 360 0; dur: 20000; easing: linear; loop: true">
        </a-entity>

        <!-- ä½›åƒ3Dæ¨¡å‹ - åˆå§‹ä¸ºé»‘ç™½æ— æè´¨ -->
        <a-gltf-model 
          id="mainModel"
          rotation="0 0 0" 
          position="0 0 0.1" 
          scale="0.8 0.8 0.8" 
          src="#buddhistModel"
          visible="false">
        </a-gltf-model>
        
        <!-- ç¥åœ£å…‰æŸ - ä»å¤©è€Œé™ -->
        <a-cylinder id="divineBeam"
                    position="0 3 0"
                    radius="0.3"
                    height="6"
                    color="#FFFFFF"
                    opacity="0"
                    material="transparent: true; shader: standard; metalness: 0.1; roughness: 0.1"
                    visible="false">
        </a-cylinder>

        <!-- å…‰ç¯æ•ˆæœ -->
        <a-ring id="halo"
                position="0 0.5 0"
                radius-inner="0.4"
                radius-outer="0.6"
                color="#FFD700"
                opacity="0"
                material="transparent: true; side: double"
                visible="false"
                animation="property: rotation; to: 0 0 360; dur: 10000; easing: linear; loop: true">
        </a-ring>

        <!-- å¢å¼ºå…‰æ•ˆç³»ç»Ÿ -->
        <a-entity id="lightRig">
          <!-- ä¸»ä½›å…‰ -->
          <a-light id="mainLight" type="point" position="0 0.3 0.3" color="#ffd700" intensity="0"></a-light>
          <a-light id="spotLight" type="spot" position="0 0.5 0.5" color="#fff3e0" intensity="0" 
                   angle="45" penumbra="0.2"></a-light>
          
          <!-- ç¥åœ£å…‰æŸå…‰æº -->
          <a-light id="divineBeamLight" type="directional" position="0 3 0" color="#ffffff" intensity="0" target="#mainModel"></a-light>
          
          <!-- å¤šè§’åº¦è¡¥å…‰ -->
          <a-light id="leftLight" type="point" position="1 0.5 0.5" color="#ffe082" intensity="0"></a-light>
          <a-light id="rightLight" type="point" position="-1 0.5 0.5" color="#ffe082" intensity="0"></a-light>
          <a-light id="bottomLight" type="point" position="0 -0.3 0.2" color="#fff8e1" intensity="0"></a-light>
        </a-entity>
        
        <!-- ç¯å¢ƒå…‰ -->
        <a-light id="ambientLight" type="ambient" color="#2c2416" intensity="0.3"></a-light>
        
        <!-- æ´çªŸæ°›å›´ -->
        <a-ring id="caveAura"
                position="0 0 -0.5" 
                radius-inner="0.8" 
                radius-outer="0.82" 
                color="#37474f" 
                opacity="0.03">
        </a-ring>
      </a-entity>
      
    </a-scene>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const startScreen = document.getElementById('startScreen');
        const startButton = document.getElementById('startButton');
        const scene = document.querySelector('a-scene');
        const debugInfo = document.getElementById('debugInfo');
        
        let isLarge = false;
        let isTracking = false;
        let effectPlaying = false;
        
        // åˆå§‹éšè—åœºæ™¯
        scene.style.display = 'none';
        
        // å¯åŠ¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        startButton.addEventListener('click', async function() {
          try {
            startScreen.style.display = 'none';
            scene.style.display = 'block';
            
            await new Promise(resolve => {
              if (scene.hasLoaded) {
                resolve();
              } else {
                scene.addEventListener('loaded', resolve);
              }
            });
            
            console.log('AR ä½›åƒåœºæ™¯å·²å¯åŠ¨');
            debugInfo.innerHTML = 'çŠ¶æ€: ARå·²å¯åŠ¨ï¼Œç­‰å¾…è¯†åˆ«å›¾';
            setupEventListeners();
            
          } catch (error) {
            console.error('å¯åŠ¨ARå¤±è´¥:', error);
            alert('å¯åŠ¨ARå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‘„åƒå¤´æƒé™å¹¶åˆ·æ–°é¡µé¢é‡è¯•');
            startScreen.style.display = 'flex';
            scene.style.display = 'none';
          }
        });
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
          const targetEntity = document.querySelector('[mindar-image-target]');
          
          // ç›®æ ‡æ£€æµ‹äº‹ä»¶
          targetEntity.addEventListener('targetFound', function() {
            console.log('è¯†åˆ«ç›®æ ‡æ‰¾åˆ° - å¼€å§‹ç¥åœ£æ˜¾ç°åºåˆ—');
            isTracking = true;
            debugInfo.innerHTML = 'çŠ¶æ€: ç›®æ ‡å·²è¯†åˆ«âœ¨<br>å¼€å§‹ç¥åœ£æ˜¾ç°...';
            
            if (!effectPlaying) {
              startManifestationSequence();
            }
          });
          
          targetEntity.addEventListener('targetLost', function() {
            console.log('è¯†åˆ«ç›®æ ‡ä¸¢å¤±');
            isTracking = false;
            debugInfo.innerHTML = 'çŠ¶æ€: ç›®æ ‡ä¸¢å¤±<br>è¯·é‡æ–°æ‰«æè¯†åˆ«å›¾';
          });
          
          // æŒ‰é’®äº‹ä»¶
          setupButtons();
        }
        
        // ç¥åœ£æ˜¾ç°åºåˆ—
        async function startManifestationSequence() {
          if (effectPlaying) return;
          effectPlaying = true;
          
          const model = document.querySelector('#mainModel');
          const manifestationParticles = document.querySelector('#manifestationParticles');
          const divineLight = document.querySelector('#divineLight');
          const ambientParticles = document.querySelector('#ambientParticles');
          const divineBeam = document.querySelector('#divineBeam');
          const halo = document.querySelector('#halo');
          
          try {
            // ç¬¬1æ­¥ï¼šæ˜¾ç°ç²’å­ç‰¹æ•ˆ (1ç§’)
            debugInfo.innerHTML = 'âœ¨ ç¬¬1æ­¥: æ˜¾ç°ç‰¹æ•ˆ';
            manifestationParticles.setAttribute('visible', true);
            await sleep(1000);
            
            // ç¬¬2æ­¥ï¼šæ˜¾ç¤ºè£¸æ¨¡ï¼ˆé»‘ç™½æ— æè´¨ï¼‰(0.5ç§’)
            debugInfo.innerHTML = 'ğŸ—¿ ç¬¬2æ­¥: æ˜¾ç°è£¸æ¨¡';
            model.setAttribute('visible', true);
            
            // è®¾ç½®ä¸ºé»‘ç™½æè´¨
            model.addEventListener('model-loaded', function() {
              setModelMaterial(model, {
                color: '#666666',
                metalness: 0.1,
                roughness: 0.9,
                opacity: 0.8
              });
            });
            
            await sleep(800);
            
            // ç¬¬3æ­¥ï¼šé€æ¸ç€è‰² (2ç§’)
            debugInfo.innerHTML = 'ğŸ¨ ç¬¬3æ­¥: é€æ¸ç€è‰²';
            await gradualColorization(model);
            
            // ç¬¬4æ­¥ï¼šç¥åœ£ä½›å…‰ä»å¤©è€Œé™ (3ç§’)
            debugInfo.innerHTML = 'ğŸŒŸ ç¬¬4æ­¥: ä½›å…‰å¤©é™';
            await showDivineBeam(divineBeam, divineLight);
            
            // ç¬¬5æ­¥ï¼šåœºæ™¯å…‰è¾‰å¢å¼º (2ç§’)
            debugInfo.innerHTML = 'ğŸ’« ç¬¬5æ­¥: å…‰è¾‰å¢å¼º';
            await enhanceSceneLighting();
            
            // ç¬¬6æ­¥ï¼šå¼€å§‹æ—‹è½¬å’Œç¯ç»•ç‰¹æ•ˆ
            debugInfo.innerHTML = 'ğŸ”„ ç¬¬6æ­¥: ç¥åœ£æ—‹è½¬';
            startRotationAndAmbience(model, halo, ambientParticles);
            
            debugInfo.innerHTML = 'âœ… ç¥åœ£æ˜¾ç°å®Œæˆ<br>ğŸ” å¯ä½¿ç”¨æŒ‰é’®äº’åŠ¨';
            effectPlaying = false;
            
          } catch (error) {
            console.error('ç‰¹æ•ˆåºåˆ—å‡ºé”™:', error);
            effectPlaying = false;
          }
        }
        
        // è®¾ç½®æ¨¡å‹æè´¨
        function setModelMaterial(model, properties) {
          setTimeout(() => {
            const mesh = model.getObject3D('mesh');
            if (mesh) {
              mesh.traverse(function(child) {
                if (child.isMesh && child.material) {
                  Object.assign(child.material, properties);
                  child.material.needsUpdate = true;
                }
              });
            }
          }, 100);
        }
        
        // é€æ¸ç€è‰²
        async function gradualColorization(model) {
          const steps = 20;
          const duration = 2000;
          const stepDuration = duration / steps;
          
          for (let i = 0; i <= steps; i++) {
            const progress = i / steps;
            const grayValue = 0.4 + (progress * 0.6); // ä»æ·±ç°åˆ°æ­£å¸¸
            
            setModelMaterial(model, {
              color: `rgb(${Math.floor(grayValue * 255)}, ${Math.floor(grayValue * 200)}, ${Math.floor(grayValue * 150)})`,
              metalness: 0.1 + (progress * 0.2),
              roughness: 0.9 - (progress * 0.3),
              opacity: 0.8 + (progress * 0.2)
            });
            
            await sleep(stepDuration);
          }
        }
        
        // æ˜¾ç¤ºç¥åœ£å…‰æŸ
        async function showDivineBeam(beam, lightParticles) {
          // æ˜¾ç¤ºå…‰æŸå’Œç²’å­
          beam.setAttribute('visible', true);
          lightParticles.setAttribute('visible', true);
          
          // å…‰æŸä»ä¸Šæ–¹é™ä¸‹å¹¶é€æ¸æ˜¾ç°
          beam.setAttribute('animation', 'property: opacity; to: 0.7; dur: 1500; easing: easeOutQuad');
          beam.setAttribute('animation__descend', 'property: position; to: 0 0 0; dur: 2500; easing: easeOutBack');
          
          // å…‰æŸå…‰æºé€æ¸å¢å¼º
          const beamLight = document.querySelector('#divineBeamLight');
          beamLight.setAttribute('animation', 'property: light.intensity; to: 3.0; dur: 2000; easing: easeInOutQuad');
          
          await sleep(3000);
          
          // å…‰æŸé€æ¸æ¶ˆå¤±ï¼Œä½†å…‰æºä¿æŒ
          beam.setAttribute('animation__fadeout', 'property: opacity; to: 0; dur: 1000; easing: easeInQuad');
          
          setTimeout(() => {
            beam.setAttribute('visible', false);
          }, 1000);
        }
        
        // å¢å¼ºåœºæ™¯å…‰æ•ˆ
        async function enhanceSceneLighting() {
          const lights = {
            mainLight: { intensity: 2.5 },
            spotLight: { intensity: 2.0 },
            leftLight: { intensity: 1.0 },
            rightLight: { intensity: 1.0 },
            bottomLight: { intensity: 0.8 }
          };
          
          // é€ä¸ªç‚¹äº®å…‰æº
          for (const [lightId, props] of Object.entries(lights)) {
            const light = document.querySelector(`#${lightId}`);
            light.setAttribute('animation', `property: light.intensity; to: ${props.intensity}; dur: 800; easing: easeOutQuad`);
            await sleep(200);
          }
          
          // å¢å¼ºç¯å¢ƒå…‰
          const ambientLight = document.querySelector('#ambientLight');
          ambientLight.setAttribute('animation', 'property: light.intensity; to: 0.8; dur: 1500; easing: easeOutQuad');
          
          await sleep(1500);
        }
        
        // å¼€å§‹æ—‹è½¬å’Œç¯ç»•ç‰¹æ•ˆ
        function startRotationAndAmbience(model, halo, ambientParticles) {
          // æ¨¡å‹å¼€å§‹æ‚¬æµ®å’Œæ—‹è½¬
          model.setAttribute('animation', 'property: position; to: 0 0 0.15; dur: 5000; easing: easeInOutSine; loop: true; dir: alternate');
          model.setAttribute('animation__rotation', 'property: rotation; to: 0 360 0; dur: 25000; easing: linear; loop: true');
          
          // æ˜¾ç¤ºå…‰ç¯
          halo.setAttribute('visible', true);
          halo.setAttribute('animation__appear', 'property: opacity; to: 0.6; dur: 2000; easing: easeOutQuad');
          
          // æ˜¾ç¤ºç¯ç»•ç²’å­
          ambientParticles.setAttribute('visible', true);
          
          // å…‰æºè·Ÿéšæ—‹è½¬
          const lightRig = document.querySelector('#lightRig');
          lightRig.setAttribute('animation', 'property: rotation; to: 0 360 0; dur: 25000; easing: linear; loop: true');
        }
        
        // æŒ‰é’®åŠŸèƒ½è®¾ç½®
        function setupButtons() {
          // ç¼©æ”¾æŒ‰é’®
          const zoomButton = document.getElementById('zoomButton');
          zoomButton.addEventListener('click', toggleModelSize);
          
          // ç‰¹æ•ˆé‡æ’­æŒ‰é’®
          const effectButton = document.getElementById('effectButton');
          effectButton.addEventListener('click', function() {
            if (isTracking && !effectPlaying) {
              resetAndReplayEffect();
            } else if (!isTracking) {
              debugInfo.innerHTML = 'âš ï¸ è¯·å…ˆæ‰«æè¯†åˆ«å›¾';
            } else {
              debugInfo.innerHTML = 'â³ ç‰¹æ•ˆæ’­æ”¾ä¸­...';
            }
          });
        }
        
        // é‡ç½®å¹¶é‡æ’­ç‰¹æ•ˆ
        function resetAndReplayEffect() {
          // éšè—æ‰€æœ‰ç‰¹æ•ˆå…ƒç´ 
          const elements = ['#mainModel', '#manifestationParticles', '#divineLight', '#ambientParticles', '#divineBeam', '#halo'];
          elements.forEach(selector => {
            const el = document.querySelector(selector);
            if (el) {
              el.setAttribute('visible', false);
              el.removeAttribute('animation');
              el.removeAttribute('animation__appear');
              el.removeAttribute('animation__descend');
              el.removeAttribute('animation__fadeout');
              el.removeAttribute('animation__rotation');
            }
          });
          
          // é‡ç½®å…‰æº
          const lights = ['#mainLight', '#spotLight', '#divineBeamLight', '#leftLight', '#rightLight', '#bottomLight', '#ambientLight'];
          lights.forEach(selector => {
            const light = document.querySelector(selector);
            if (light) {
              light.setAttribute('light', 'intensity', 0);
              light.removeAttribute('animation');
            }
          });
          
          // é‡æ–°å¼€å§‹åºåˆ—
          setTimeout(() => {
            startManifestationSequence();
          }, 500);
        }
        
        // æ¨¡å‹ç¼©æ”¾åŠŸèƒ½
        function toggleModelSize() {
          if (scene.style.display === 'none') {
            debugInfo.innerHTML = 'çŠ¶æ€: è¯·å…ˆç‚¹å‡»å¯åŠ¨ARä½“éªŒ';
            return;
          }
          
          const model = document.querySelector('#mainModel');
          if (!model || !model.getAttribute('visible')) {
            debugInfo.innerHTML = 'çŠ¶æ€: è¯·å…ˆæ‰«æè¯†åˆ«å›¾';
            return;
          }
          
          if (!isLarge) {
            model.setAttribute('animation__scale', 'property: scale; to: 1.8 1.8 1.8; dur: 1500; easing: easeOutBack');
            model.setAttribute('position', '0 0 0.4');
            zoomButton.innerHTML = 'ğŸ” ç¼©å°ä½›åƒ';
            zoomButton.style.background = 'linear-gradient(45deg, #ff6b6b, #ee5a24)';
            isLarge = true;
            debugInfo.innerHTML = 'çŠ¶æ€: ä½›åƒå·²æ”¾å¤§âœ¨';
          } else {
            model.setAttribute('animation__scale', 'property: scale; to: 0.8 0.8 0.8; dur: 1200; easing: easeInOutQuad');
            model.setAttribute('animation', 'property: position; to: 0 0 0.15; dur: 5000; easing: easeInOutSine; loop: true; dir: alternate');
            zoomButton.innerHTML = 'ğŸ” æ”¾å¤§ä½›åƒ';
            zoomButton.style.background = 'linear-gradient(45deg, #ffd700, #ff8f00)';
            isLarge = false;
            debugInfo.innerHTML = 'çŠ¶æ€: ä½›åƒå·²ç¼©å°';
          }
        }
        
        // å·¥å…·å‡½æ•°
        function sleep(ms) {
          return new Promise(resolve => setTimeout(resolve, ms));
        }
      });
    </script>
  </body>
</html>
