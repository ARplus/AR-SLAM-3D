<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Web AR 冰箱贴 Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

  <!-- A-Frame 核心 -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.3.0/dist/aframe.min.js"></script>
  <!-- MindAR for A-Frame -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-aframe.prod.js"></script>
  <!-- 粒子组件 -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-particle-system-component@1.0.0/dist/aframe-particle-system-component.min.js"></script>
  <!-- 手势识别 -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-gesture-detector@4.0.2/dist/aframe-gesture-detector.min.js"></script>

  <script>
    // 手势处理组件：捏合缩放 + 拖拽旋转
    AFRAME.registerComponent('gesture-handler', {
      init: function () {
        this.onRotate = this.onRotate.bind(this);
        this.onPinch  = this.onPinch.bind(this);
        this.el.addEventListener('rotate', this.onRotate);
        this.el.addEventListener('pinch',  this.onPinch);
      },
      onRotate: function (ev) {
        const r = this.el.getAttribute('rotation');
        // 根据手势水平移动角度旋转 Y 轴
        this.el.setAttribute('rotation', {
          x: r.x,
          y: r.y + ev.detail.positionChange.x,
          z: r.z
        });
      },
      onPinch: function (ev) {
        const s = this.el.getAttribute('scale');
        // 根据捏合比例统一缩放
        const newScale = s.x * ev.detail.spreadChange;
        this.el.setAttribute('scale', `${newScale} ${newScale} ${newScale}`);
      }
    });
  </script>
</head>

<body style="margin: 0; overflow: hidden;">
  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind; maxTrack: 1;"
    embedded
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights: true"
  >
    <a-assets>
      <!-- 三个 GLB 模型 -->
      <a-asset-item id="buddhistModel" src="buddhist.glb"></a-asset-item>
      <a-asset-item id="cloudModel"    src="cloud.glb"></a-asset-item>
      <a-asset-item id="dragonModel"   src="dragon.glb"></a-asset-item>
      <!-- 音频文件 -->
      <audio id="bell"  src="bell.mp3"></audio>
      <audio id="chant" src="chant.mp3"></audio>
    </a-assets>

    <!-- 识别到目标后显示内容 -->
    <a-entity mindar-image-target="targetIndex: 0">

      <!-- 改进版粒子：preset dust, sprite 贴图也可以替换 -->
      <a-entity
        particle-system="
          preset: dust;
          particleCount: 800;
          color: #dddddd,#888888;
          size: 0.02;
          opacity: 0.6;
          velocityValue: 0 0.5 0;
          accelerationValue: 0 -0.1 0;
          duration: 6;
          blending: additive;
          texture: https://cdn.jsdelivr.net/gh/aframevr/aframe-particle-system-component@master/dist/images/spark1.png
        "
      ></a-entity>

      <!-- 模型组：手势旋转+缩放 -->
      <a-entity
        id="model-group"
        gesture-handler
        rotation="0 0 0"
        scale="0.1 0.1 0.1"
        position="0 0 0"
      >
        <a-gltf-model src="#buddhistModel" position="0 0 0"></a-gltf-model>
        <a-gltf-model src="#cloudModel"    position="0 0 0"></a-gltf-model>
        <a-gltf-model src="#dragonModel"   position="0 0 0"></a-gltf-model>
      </a-entity>

      <!-- 音频实体：不开 autoplay -->
      <a-entity id="sound-bell"  sound="src: #bell;  autoplay: false;"></a-entity>
      <a-entity id="sound-chant" sound="src: #chant; autoplay: false;"></a-entity>
    </a-entity>

    <!-- 摄像头 -->
    <a-camera position="0 0 0"></a-camera>
  </a-scene>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const sceneEl = document.querySelector('a-scene');

      // 监听 targetFound/play
      sceneEl.addEventListener('targetFound', () => {
        // 确保 AudioContext 已经 resume
        const audioCtx = AFRAME.audioListener.context;
        if (audioCtx.state === 'suspended') { audioCtx.resume(); }

        document.querySelector('#sound-bell').components.sound.playSound();
        document.querySelector('#sound-chant').components.sound.playSound();
      });

      // 识别丢失时停止音效
      sceneEl.addEventListener('targetLost', () => {
        document.querySelector('#sound-bell').components.sound.stopSound();
        document.querySelector('#sound-chant').components.sound.stopSound();
      });

      // 再次尝试在用户任意交互时恢复 AudioContext（防止有时因浏览器策略被挂起）
      ['click','touchend'].forEach(evt => {
        window.addEventListener(evt, () => {
          const ctx = AFRAME.audioListener.context;
          if (ctx.state === 'suspended') { ctx.resume(); }
        });
      });
    });
  </script>
</body>
</html>
